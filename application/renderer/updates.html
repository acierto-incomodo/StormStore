<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Actualizaciones - StormStore</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/png" href="../assets/app.png" />
</head>

<body>
  <aside class="sidebar">
    <div class="sidebar-top">
      <div class="brand-container">
        <h2>StormStore</h2>
        <p class="version" id="app-version"></p>
      </div>

      <button id="back-to-apps" class="back-button">
        ← Volver a aplicaciones
      </button>

      <ul id="categories"></ul>
    </div>

    <div class="sidebar-footer">
      <p class="studio">StormGamesStudios</p>
    </div>
  </aside>

  <main class="dashboard-layout">
    <div class="main-header">
      <h1>Actualizaciones</h1>
      <div class="window-controls">
        <button class="control-btn" id="min-btn">─</button>
        <button class="control-btn" id="max-btn">◻</button>
        <button class="control-btn close" id="close-btn">✕</button>
      </div>
    </div>
    <div class="updates-container">
      <div class="update-section">
        <h2>Versión actual</h2>
        <p class="current-version" id="current-version">Cargando...</p>
      </div>

      <div class="update-section">
        <h2>Buscar actualizaciones</h2>
        <button id="check-updates-btn" class="primary-btn">
          Buscar actualizaciones
        </button>
        <p id="check-status" class="status-message"></p>
      </div>

      <div id="update-info-section" class="update-section" style="display: none;">
        <h2>Actualización disponible</h2>
        <div class="update-details">
          <p><strong>Nueva versión:</strong> <span id="new-version">-</span></p>
          <p><strong>Versión actual:</strong> <span id="old-version">-</span></p>
          <p><strong>Fecha de lanzamiento:</strong> <span id="release-date">-</span></p>
          <p><strong>Descripción:</strong></p>
          <div id="release-notes" class="release-notes">-</div>
        </div>
        <div class="button-group">
          <button id="download-btn" class="primary-btn">Descargar actualización</button>
        </div>
        <div id="download-progress" style="display: none; margin-top: 20px;">
          <p id="progress-text">Descargando...</p>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
          </div>
        </div>
      </div>

      <div id="no-update-section" class="update-section" style="display: none;">
        <h2>Estás actualizado</h2>
        <p>Ya tienes la versión más reciente de StormStore instalada.</p>
      </div>

      <div id="update-ready-section" class="update-section" style="display: none;">
        <h2>Actualización lista para instalar</h2>
        <p>La actualización ha sido descargada correctamente.</p>
        <button id="install-btn" class="primary-btn">Instalar y reiniciar ahora</button>
      </div>

      <div id="error-section" class="update-section" style="display: none;">
        <h2>Error</h2>
        <p id="error-message" class="error-message">-</p>
        <button id="retry-btn" class="secondary-btn">Reintentar</button>
      </div>
    </div>
  </main>

  <script>
    // Esperar a que el DOM esté completamente cargado
    document.addEventListener("DOMContentLoaded", function () {
      // Cargar versión actual
      loadCurrentVersion();

      // Volver a aplicaciones
      const backBtn = document.getElementById("back-to-apps");
      if (backBtn) {
        backBtn.addEventListener("click", function (e) {
          e.preventDefault();
          window.location.href = "index.html";
        });
      } else {
        console.error("No se encontró el botón back-to-apps");
      }

      // Buscar actualizaciones
      document.getElementById("check-updates-btn").addEventListener("click", () => {
        const statusEl = document.getElementById("check-status");
        const checkBtn = document.getElementById("check-updates-btn");

        statusEl.textContent = "Buscando actualizaciones...";
        checkBtn.disabled = true;

        // Ocultar los resultados anteriores para una UI más limpia
        document.getElementById("update-info-section").style.display = "none";
        document.getElementById("no-update-section").style.display = "none";
        document.getElementById("error-section").style.display = "none";

        // Disparamos la comprobación. Los 'listeners' de eventos (onUpdateAvailable, etc.)
        // se encargarán de mostrar el resultado correcto.
        window.api.checkForUpdates();
      });

      // Descargar actualización
      document.getElementById("download-btn").addEventListener("click", async () => {
        document.getElementById("download-progress").style.display = "block";
        document.getElementById("download-btn").disabled = true;

        try {
          await window.api.downloadUpdate();
        } catch (err) {
          showError(`Error descargando actualización: ${err.message}`);
        }
      });

      // Instalar actualización
      document.getElementById("install-btn").addEventListener("click", () => {
        window.api.installUpdate();
      });

      // Reintentar
      document.getElementById("retry-btn").addEventListener("click", () => {
        document.getElementById("check-updates-btn").click();
      });

      // Escuchar eventos desde el main process
      window.api.onUpdateAvailable((_, info) => {
        resetCheckUI();
        showUpdateAvailable(info);
      });

      window.api.onUpdateNotAvailable(() => {
        showNoUpdate();
        resetCheckUI();
      });

      window.api.onDownloadProgress((_, progressObj) => {
        const percent = progressObj.percent.toFixed(1);
        const transferred = (progressObj.transferred / 1024 / 1024).toFixed(2);
        const total = (progressObj.total / 1024 / 1024).toFixed(2);
        const speed = (progressObj.bytesPerSecond / 1024 / 1024).toFixed(2);

        document.getElementById("progress-fill").style.width = percent + "%";
        document.getElementById("progress-text").textContent = `Descargando: ${percent}% (${transferred} MB / ${total} MB) - ${speed} MB/s`;
      });

      window.api.onUpdateDownloaded(() => {
        document.getElementById("download-progress").style.display = "none";
        document.getElementById("update-info-section").style.display = "none";
        document.getElementById("update-ready-section").style.display = "block";
      });

      window.api.onUpdateError((_, message) => {
        resetCheckUI();
        showError(`Error: ${message}`);
      });

      // Controles de ventana
      document.getElementById("min-btn")?.addEventListener("click", () => window.api.minimizeWindow());
      document.getElementById("close-btn")?.addEventListener("click", () => window.api.closeWindow());

      const maxBtn = document.getElementById("max-btn");
      if (maxBtn) {
        maxBtn.addEventListener("click", () => window.api.maximizeWindow());

        window.api.isMaximized().then((isMax) => {
          if (isMax) maxBtn.textContent = "❐";
        });

        window.api.onWindowMaximized(() => (maxBtn.textContent = "❐"));
        window.api.onWindowRestored(() => (maxBtn.textContent = "◻"));
      }
    });

    // Cargar versión actual
    async function loadCurrentVersion() {
      const version = await window.api.getAppVersion();
      document.getElementById("app-version").textContent = `v${version}`;
      document.getElementById("current-version").textContent = `v${version}`;
    }

    function resetCheckUI() {
      document.getElementById("check-status").textContent = "";
      document.getElementById("check-updates-btn").disabled = false;
    }

    function showUpdateAvailable(info) {
      // Ocultar el botón de volver para forzar la actualización
      const backBtn = document.getElementById("back-to-apps");
      if (backBtn) {
        backBtn.style.display = "none";
      }

      document.getElementById("update-info-section").style.display = "block";
      document.getElementById("no-update-section").style.display = "none";
      document.getElementById("error-section").style.display = "none";

      document.getElementById("new-version").textContent = info.version || "Desconocida";
      const currentVersion = document.getElementById("app-version").textContent.slice(1);
      document.getElementById("old-version").textContent = currentVersion;

      if (info.releaseDate) {
        const date = new Date(info.releaseDate);
        document.getElementById("release-date").textContent = date.toLocaleDateString("es-ES");
      }

      document.getElementById("release-notes").innerHTML = info.releaseNotes || "Sin descripción disponible";

      // Abrir enlaces en el navegador externo
      const links = document.getElementById("release-notes").querySelectorAll("a");
      links.forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          window.open(link.href, "_blank");
        });
      });
    }

    function showNoUpdate() {
      document.getElementById("update-info-section").style.display = "none";
      document.getElementById("no-update-section").style.display = "block";
      document.getElementById("error-section").style.display = "none";
    }

    function showError(message) {
      document.getElementById("update-info-section").style.display = "none";
      document.getElementById("no-update-section").style.display = "none";
      document.getElementById("error-section").style.display = "block";
      document.getElementById("error-message").textContent = message;
    }
  </script>
</body>

</html>