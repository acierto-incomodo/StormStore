<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detalles de la Aplicación</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/png" href="../assets/app.png" />
</head>

<body>
  <div id="install-overlay">
    <div class="install-box">
      <img src="../assets/icons/loading-new.svg" alt="Cargando" />
      <p>Instalando aplicación…</p>
    </div>
  </div>

  <div id="no-internet-overlay">
    <h1>No hay conexión a Internet</h1>
    <p>Revisa tu conexión y espera...</p>
  </div>

  <aside class="sidebar">
    <div class="sidebar-top">
      <div class="brand-container">
        <h2>StormStore</h2>
        <p class="version" id="app-version"></p>
      </div>

      <button id="back-btn" class="back-button">← Volver a aplicaciones</button>

      <ul id="categories"></ul>
    </div>

    <div class="sidebar-footer">
      <p class="studio">StormGamesStudios</p>

      <div class="footer-icons">
        <button data-link="https://github.com/acierto-incomodo">
          <img src="../assets/icons/github.svg" alt="GitHub" />
        </button>
        <button data-link="https://stormgamesstudios.vercel.app/">
          <img src="../assets/icons/web.svg" alt="Web" style="filter: invert(1)" />
        </button>
        <button data-link="https://www.curseforge.com/members/creper1125463">
          <img src="../assets/icons/curseforge.svg" alt="CurseForge" />
        </button>
        <button id="open-updates">
          <img src="../assets/icons/update.svg" alt="Actualizaciones" />
        </button>
        <button id="open-licenses">
          <img src="../assets/icons/license.svg" alt="Licencias" />
        </button>
        <button id="open-info">
          <img src="../assets/icons/info.svg" alt="Información" />
        </button>
      </div>
    </div>
  </aside>

  <main class="dashboard-layout">
    <div class="main-header">
      <h1 id="header-title">Cargando...</h1>
      <div class="window-controls">
        <button class="control-btn" id="open-big-picture" title="StormVortex">
          <img src="../assets/icons/big-picture.svg" alt="StormVortex" style="width: 20px; height: 20px;" />
        </button>
        <button class="control-btn" id="min-btn">─</button>
        <button class="control-btn" id="max-btn">◻</button>
        <button class="control-btn close" id="close-btn">✕</button>
      </div>
    </div>

    <div class="updates-container">
      <div id="app-detail-container" class="animate-enter" style="display: flex; gap: 40px; align-items: flex-start;">
        <!-- El contenido se inyectará aquí -->
      </div>
    </div>
  </main>

  <script>
    const params = new URLSearchParams(window.location.search);
    const appId = params.get("id");
    const container = document.getElementById("app-detail-container");
    const headerTitle = document.getElementById("header-title");
    const versionElem = document.getElementById("app-version");
    let isInstalling = false;
    let isUninstalling = false;

    function playSound(soundFile) {
      new Audio(`../assets/media/sounds/${soundFile}`).play();
    }

    function showToast(message) {
      let toast = document.getElementById("toast-notification");
      if (!toast) {
        toast = document.createElement("div");
        toast.id = "toast-notification";
        toast.className = "toast-notification";
        document.body.appendChild(toast);
      }
      toast.textContent = message;
      toast.classList.add("show");
      setTimeout(() => {
        toast.classList.remove("show");
      }, 3000);
    }

    // Mostrar versión
    if (versionElem) {
      window.api.getAppVersion().then((v) => {
        versionElem.textContent = "v" + v;
      });
    }

    // Botón Volver
    document.getElementById("back-btn").addEventListener("click", () => {
      window.history.back();
    });

    // Footer links
    document.querySelectorAll(".footer-icons button[data-link]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const url = btn.getAttribute("data-link");
        window.open(url);
      });
    });
    document.getElementById("open-updates")?.addEventListener("click", () => {
      window.location.href = "updates.html";
    });
    document.getElementById("open-licenses")?.addEventListener("click", () => {
      window.location.href = "licencias.html";
    });
    document.getElementById("open-big-picture")?.addEventListener("click", () => {
      window.api.openBigPicture();
    });
    document.getElementById("open-info")?.addEventListener("click", () => {
      window.location.href = "info.html";
    });

    // Controles de ventana
    document.getElementById("min-btn")?.addEventListener("click", () => window.api.minimizeWindow());
    document.getElementById("close-btn")?.addEventListener("click", () => window.api.closeWindow());
    const maxBtn = document.getElementById("max-btn");
    if (maxBtn) {
      maxBtn.addEventListener("click", () => window.api.maximizeWindow());
      window.api.isMaximized().then((isMax) => { if (isMax) maxBtn.textContent = "❐"; });
      window.api.onWindowMaximized(() => (maxBtn.textContent = "❐"));
      window.api.onWindowRestored(() => (maxBtn.textContent = "◻"));
    }

    // Cargar datos
    async function loadApp() {
      const apps = await window.api.getApps();
      let app = apps.find(a => a.id === appId);

      if (!app) {
        const steamApps = await window.api.getSteamGames();
        app = steamApps.find(a => a.id === appId);
      }

      if (!app) {
        const epicGames = await window.api.getEpicGames();
        app = epicGames.find(a => a.id === appId);
      }

      if (!app) {
        headerTitle.textContent = "Aplicación no encontrada";
        container.innerHTML = "<p>No se pudo encontrar la información de la aplicación.</p>";
        return;
      }

      headerTitle.textContent = app.name;
      renderDetails(app);
    }

    function renderDetails(app) {
      container.innerHTML = "";

      // Imagen grande
      const imgContainer = document.createElement("div");
      imgContainer.style.position = "relative";
      imgContainer.style.width = "200px";
      imgContainer.style.height = "200px";
      imgContainer.style.flexShrink = "0";

      const img = document.createElement("img");
      img.src = app.icon;
      img.className = "app-icon";
      img.style.width = "100%";
      img.style.height = "100%";
      img.style.borderRadius = "16px";
      img.style.objectFit = "cover";
      img.style.boxShadow = "0 4px 12px rgba(0,0,0,0.5)";

      const wifiBadge = document.createElement("img");
      wifiBadge.src = "../assets/icons/sin-wifi.svg";
      wifiBadge.className = "wifi-badge";

      if (app.wifi === "si") {
        imgContainer.classList.add("requires-wifi");
      }

      imgContainer.append(img, wifiBadge);

      // Info container
      const infoDiv = document.createElement("div");
      infoDiv.style.flex = "1";
      infoDiv.style.display = "flex";
      infoDiv.style.flexDirection = "column";
      infoDiv.style.gap = "16px";

      const desc = document.createElement("p");
      desc.textContent = app.description;
      desc.style.fontSize = "16px";
      desc.style.lineHeight = "1.6";
      desc.style.color = "#ddd";

      const actionsDiv = document.createElement("div");
      actionsDiv.style.display = "flex";
      actionsDiv.style.gap = "12px";
      actionsDiv.style.marginTop = "20px";

      if (app.wifi === "si") {
        actionsDiv.classList.add("requires-wifi");
      }

      if (app.installed) {
        // Botón Abrir
        const openBtn = document.createElement("button");
        openBtn.textContent = "Abrir";
        openBtn.className = "md-btn md-btn-filled";
        openBtn.style.padding = "12px 24px";
        openBtn.style.flex = "1";
        openBtn.onclick = () => window.api.openApp(app.paths[0], app.steam === "si");
        
        // Botón Ubicación
        const locBtn = document.createElement("button");
        locBtn.textContent = "Ubicación";
        locBtn.className = "md-btn md-btn-blue";
        locBtn.style.padding = "12px 24px";
        locBtn.style.flex = "1";
        locBtn.onclick = () => {
          playSound("others.mp3");
          window.api.openAppLocation(app.installPath || app.paths[0]);
          showToast("Abriendo ubicación...");
        };

        // Botón Share (si aplica)
        let shareBtn = null;
        if (app["share-compatibility"] === "si") {
          shareBtn = document.createElement("button");
          shareBtn.className = "md-btn md-btn-tonal";
          shareBtn.style.padding = "12px 16px";
          shareBtn.innerHTML = '<img src="../assets/icons/share.svg" alt="Share" style="width: 20px; height: 20px;">';
          shareBtn.style.marginLeft = "auto";
          shareBtn.onclick = () => {
             playSound("others.mp3");
             navigator.clipboard.writeText(`Juega conmigo a https://stormgamesstudios.vercel.app/juegos/juegos-url/${app.id}/play`);
             showToast("Enlace copiado al portapapeles");
          };
        }

        // Botón Desinstalar
        const uninstallBtn = document.createElement("button");
        uninstallBtn.textContent = isUninstalling ? "Desinstalando..." : "Desinstalar";
        uninstallBtn.className = "md-btn md-btn-danger";
        uninstallBtn.style.padding = "12px 24px";
        uninstallBtn.style.flex = "1";
        uninstallBtn.disabled = isUninstalling;
        
        if (app.uninstall) {
            uninstallBtn.onclick = async () => {
                isUninstalling = true;
                showToast("Desinstalando aplicación...");
                renderDetails(app); // Re-render para actualizar estado visual
                try {
                    await window.api.uninstallApp(app.uninstall);
                    playSound("finish.mp3");
                } catch (e) { console.error(e); }
                isUninstalling = false;
                loadApp(); // Recargar estado
            };
            if (!isUninstalling) {
              actionsDiv.append(openBtn, locBtn, uninstallBtn);
              if (shareBtn) actionsDiv.append(shareBtn);
            } else {
              actionsDiv.append(uninstallBtn);
            }
        } else {
            actionsDiv.append(openBtn, locBtn);
            if (shareBtn) actionsDiv.append(shareBtn);
        }

      } else {
        // Botón Instalar
        const installBtn = document.createElement("button");
        installBtn.textContent = isInstalling ? "Instalando..." : "Instalar";
        installBtn.className = "md-btn md-btn-filled";
        installBtn.style.padding = "12px 24px";
        installBtn.style.fontSize = "16px";
        installBtn.style.flex = "1";
        installBtn.disabled = isInstalling;
        installBtn.onclick = async () => {
            isInstalling = true;
            playSound("others.mp3");
            showToast("Iniciando instalación...");
            renderDetails(app);
            try { 
              await window.api.installApp(app);
              playSound("finish.mp3");
            } catch (e) { console.error(e); }
            isInstalling = false;
            loadApp();
        };
        actionsDiv.appendChild(installBtn);

        if (app["share-compatibility"] === "si") {
          const shareBtn = document.createElement("button");
          shareBtn.className = "md-btn md-btn-tonal";
          shareBtn.style.padding = "12px 16px";
          shareBtn.innerHTML = '<img src="../assets/icons/share.svg" alt="Share" style="width: 20px; height: 20px;">';
          shareBtn.style.marginLeft = "auto";
          shareBtn.onclick = () => {
             playSound("others.mp3");
             navigator.clipboard.writeText(`Juega conmigo a https://stormgamesstudios.vercel.app/juegos/juegos-url/${app.id}/play`);
             showToast("Enlace copiado al portapapeles");
          };
          actionsDiv.appendChild(shareBtn);
        }
      }

      infoDiv.append(desc);

      // --- Requisitos ---
      const requirementsContainer = document.createElement("div");
      requirementsContainer.style.display = "flex";
      requirementsContainer.style.flexDirection = "column";
      requirementsContainer.style.gap = "4px"; // Espacio reducido entre requisitos
      requirementsContainer.style.marginTop = "10px";

      const createRequirement = (text, iconSrc) => {
        const p = document.createElement("p");
        p.style.color = "var(--md-sys-color-primary)";
        p.style.background = "rgba(0,0,0,0.2)";
        p.style.padding = "12px";
        p.style.borderRadius = "var(--md-sys-shape-corner-medium)";
        p.style.display = "flex";
        p.style.alignItems = "center";
        p.style.gap = "10px";

        const icon = document.createElement("img");
        icon.src = iconSrc;
        icon.style.width = "24px";
        icon.style.height = "24px";

        const textSpan = document.createElement("span");
        textSpan.innerHTML = `<strong>Requisito:</strong> ${text}`;
        
        p.append(icon, textSpan);
        return p;
      };

      if (app.steam === "si") {
        requirementsContainer.appendChild(createRequirement("Se necesita tener Steam iniciado.", "../assets/icons/steam.svg"));
      }

      if (app.wifi === "si") {
        requirementsContainer.appendChild(createRequirement("Se necesita conexión a Internet.", "../assets/icons/wifi.svg"));
      }

      if (requirementsContainer.hasChildNodes()) {
        infoDiv.appendChild(requirementsContainer);
      }

      infoDiv.append(actionsDiv);

      // Trailer
      const trailerContainer = document.createElement("div");
      trailerContainer.style.marginTop = "20px";
      trailerContainer.style.width = "100%";

      window.api.checkTrailerExists(app.id).then((exists) => {
        if (exists) {
          const video = document.createElement("video");
          video.controls = true;
          video.style.width = "100%";
          video.style.borderRadius = "12px";
          video.style.boxShadow = "0 4px 12px rgba(0,0,0,0.3)";
          
          const source = document.createElement("source");
          source.src = `../assets/media/trailers/${app.id}.mp4`;
          source.type = "video/mp4";
          
          video.appendChild(source);
          trailerContainer.appendChild(video);
        }
      });
      infoDiv.appendChild(trailerContainer);

      container.append(imgContainer, infoDiv);
    }

    function updateInternetStatus() {
      const overlay = document.getElementById("no-internet-overlay");
      fetch("https://www.google.com", { mode: "no-cors" })
        .then(() => {
          if (overlay) overlay.style.display = "none";
          document.body.classList.remove("offline");
        })
        .catch(() => {
          if (overlay) overlay.style.display = "none";
          document.body.classList.add("offline");
        });
    }
    updateInternetStatus();
    setInterval(updateInternetStatus, 1000);

    loadApp();
  </script>
  <script src="gamepad-global.js"></script>
</body>
</html>